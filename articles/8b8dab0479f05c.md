---
title: "OutLineShaderを考える"
emoji: "📑"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: [Shader]
published: false
---

### 単純な拡大で生成する方法

普通に画像を拡大してみる。

![altテキスト](https://storage.googleapis.com/zenn-user-upload/f0ac696b7edbccac560ab89c.png =320x)
*単純な拡大によるアウトライン生成*

一段目の四角形は問題なくアウトラインが表現されている。
二段目の画像では右側のアウトラインが出ていない。
三段目の画像でも内側にアウトラインが出ていない。

この方法は原点から拡大をするため、原点との距離でアウトラインの幅が変わってしまったり、原点の方を向いている辺ではアウトラインがモデルの内側に入り込んでしまう問題がある。

![altテキスト](https://storage.googleapis.com/zenn-user-upload/3a3ee649ca75e73e65d88c37.png =320x)

解決方法としては、各々の辺から外側に向かってアウトラインを生成したい。

そこでShaderを使ってモデルのアウトラインを生成してみる。

### 法線方向に拡大する方法
基本的には先ほどの画像の拡大と考え方は一緒です。
違いは「原点から拡大」しているのではなく、「法線方向に拡大」している点です。

#### 法線とは

#### コード

```NormalOutLine.shader
Shader "Unlit/NormalOutLine"
{
    Properties
    {
        _MainTex ("Texture", 2D) = "white" {}
        _BaseColor("BaseColor", Color) = (1, 1, 1, 1)
        _OutlineColor("Color", Color) = (1, 1, 1, 1)
        _OutlineWidth("Width", float) = 1
    }
    SubShader
    {
        Tags { "RenderType"="Opaque" }
        LOD 100

        Pass // 1
        {
            cull Front
            CGPROGRAM
            #pragma vertex vert
            #pragma fragment frag
            #include "UnityCG.cginc"

            struct appdata
            {
                float4 vertex : POSITION;
                float3 normal : NORMAL;
            };

            struct v2f
            {
                float4 vertex : SV_POSITION;
            };

            half _OutlineWidth;
            half4 _OutlineColor;
            
            v2f vert (appdata v)
            {
                v2f o;
                o.vertex = UnityObjectToClipPos(v.vertex +  v.normal * _OutlineWidth / 100);
                return o;
            }

            fixed4 frag (v2f i) : SV_Target
            {
                return _OutlineColor;
            }
            ENDCG
        }
        
        Pass // 2
        {
            CGPROGRAM
            #pragma vertex vert
            #pragma fragment frag

            #include "UnityCG.cginc"

            struct appdata
            {
                float4 vertex : POSITION;
                float2 uv : TEXCOORD0;
            };

            struct v2f
            {
                float2 uv : TEXCOORD0;
                float4 vertex : SV_POSITION;
            };

            half4 _BaseColor;

            v2f vert (appdata v)
            {
                v2f o;
                o.vertex = UnityObjectToClipPos(v.vertex);
                return o;
            }

            fixed4 frag (v2f i) : SV_Target
            {
                return _BaseColor;
            }
            ENDCG
        }
    }
}
```

それではこのShaderを適応してみましょう。
インスペクター上で[3D Object > Cube]を選択してキューブを、続けて[3D Object > Sphere]を選択してスフィアを作成してください。
この２つのモデルに上記のNormalOutLine.shaderを適応します。

![altテキスト](https://storage.googleapis.com/zenn-user-upload/12ca09603aa93ea89bd26655.png =640x)
*キューブとスフィアのアウトライン生成*

スフィアは問題ありませんが、キューブのアウトラインが切れてしまっています。
これは**頂点が持っている法線データの違い**によるものです。

実際にBlenderで見てみましょう。

![altテキスト](https://storage.googleapis.com/zenn-user-upload/ec99e700ee869c47a7bed14e.png =640x)
*キューブと面ごとの法線(ピンク色の線)*

各頂点から面ごとの法線を表示してみました。確かに面から垂直に法線が引かれているため法線方向に拡大すると角の部分にはアウトラインが生成されることはなさそうです。

Blender上で板ポリをおいて実際にシミュレートした結果がこちらです。

![altテキスト](https://storage.googleapis.com/zenn-user-upload/b3896703c78e8b7c3acbe2bd.png =640x)
*垂直な法線のシミュレーション*

面から法線に沿って垂直にアウトラインを作成すると、Unity上で見た状態になりましたね。

次は頂点の法線データをBlender編集してUnityに持っていき、想定しているアウトラインが出るか確認します。
簡略化のため、一時的にキューブの１面だけで考え、予想されるアウトラインをオレンジの板て表現しています。

![altテキスト](https://storage.googleapis.com/zenn-user-upload/df20601f2e75c9eaadcb2a14.png =640x)
*法線が面に対して垂直な状態*

現在はこのように面に対して垂直な法線になっているため、アウトラインが角までカバーできていない状態です。

![altテキスト](https://storage.googleapis.com/zenn-user-upload/de76e52f8bb6d93cc9025f66.png =640x)
*法線が関連する面の平均ベクトルの状態*

そこで上記のように角の法線を関連する面の平均ベクトルになるように編集しました。

![altテキスト](https://storage.googleapis.com/zenn-user-upload/a0b727c8a4d815928e382d5a.png =640x)
*法線修正後の面ごとの法線(ピンク色の線)*

平均ベクトルの法線であれば、このシミュレーション通りになるはずです。

![altテキスト](https://storage.googleapis.com/zenn-user-upload/6658a3a3199d37bf6f3b8d36.png =640x)
*平均ベクトルの法線のシミュレーション*

それではUnityで確認をしてみましょう。

![altテキスト](https://storage.googleapis.com/zenn-user-upload/26abc69953ac8212c3a51da0.png =640x)
*モデル修正前(左)とモデル修正後(右)*

無事にキューブのアウトラインを作ることが出来ました。
つまり原因は**法線データが面から垂直になため、角の部分にアウトラインが生成できていない**という事でした。

スフィアはなぜ綺麗なアウトラインが出来ていたかというと、こちらは元から法線が面ごとに垂直になっておらず、平均ベクトルとなっていたためです。

### 問題点

重なりに対応できない。

![altテキスト](https://storage.googleapis.com/zenn-user-upload/4fb7023a07f3bc6592c94317.png =640x)
*重なった際の表示*

#### 参考サイト
https://light11.hatenadiary.com/entry/2018/05/13/183314